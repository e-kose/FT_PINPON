groups:
  - name: api_performance_recording
    interval: 30s
    rules:
      # HTTP Request Rate Recording Rules
      - record: job:http_requests:rate5m
        expr: sum(rate(http_requests_total[5m])) by (job)

      - record: job:http_requests:rate1m
        expr: sum(rate(http_requests_total[1m])) by (job)

      # HTTP Error Rate Recording Rules
      - record: job:http_errors:rate5m
        expr: sum(rate(http_requests_total{status=~"5.."}[5m])) by (job)

      - record: job:http_error_rate:ratio
        expr: sum(rate(http_requests_total{status=~"5.."}[5m])) by (job) / sum(rate(http_requests_total[5m])) by (job)

      # Response Time Recording Rules
      - record: job:http_request_duration:p50
        expr: histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

      - record: job:http_request_duration:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

      - record: job:http_request_duration:p99
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

  - name: resource_recording
    interval: 30s
    rules:
      # CPU Recording Rules
      - record: instance:cpu_usage:percent
        expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      # Memory Recording Rules
      - record: instance:memory_usage:percent
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

      - record: instance:memory_available:bytes
        expr: node_memory_MemAvailable_bytes

      # Disk Recording Rules
      - record: instance:disk_usage:percent
        expr: (1 - (node_filesystem_avail_bytes{fstype!="tmpfs",fstype!="overlay"} / node_filesystem_size_bytes{fstype!="tmpfs",fstype!="overlay"})) * 100

  - name: container_recording
    interval: 30s
    rules:
      # Container CPU Recording
      - record: container:cpu_usage:rate5m
        expr: sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) by (name)

      # Container Memory Recording
      - record: container:memory_usage:bytes
        expr: sum(container_memory_usage_bytes{name!=""}) by (name)

      - record: container:memory_usage:percent
        expr: (sum(container_memory_usage_bytes{name!=""}) by (name) / sum(container_spec_memory_limit_bytes{name!=""}) by (name)) * 100

  - name: database_recording
    interval: 30s
    rules:
      # Redis Recording Rules
      - record: redis:memory_usage:percent
        expr: (redis_memory_used_bytes / redis_memory_max_bytes) * 100

      - record: redis:connected_clients:total
        expr: redis_connected_clients

      - record: redis:commands:rate5m
        expr: rate(redis_commands_processed_total[5m])
